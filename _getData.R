library(dplyr) #bind_rows

featureEngineerSimple = function(data) {
  #impute missing values in Age, Fare, Embarked
  print('Imputing missing values...')
  require(mice)
  set.seed(129)
  mice_imp = mice(subset(data, select=-c(PassengerId, Name, Ticket, Cabin, Survived)), method='rf', printFlag=F)
  mice_output = complete(mice_imp)
  data$Age = mice_output$Age
  data$Fare = mice_output$Fare
  data$Embarked = mice_output$Embarked

  return(data)
}

featureEngineer = function(data) {
  #create Title feature from Name
  data$Title = gsub('(.*, )|(\\..*)', '', data$Name)
  data$Title[data$Title == 'Mlle' | data$Title == 'Ms'] = 'Miss'
  data$Title[data$Title == 'Mme'] = 'Mrs'
  data$Title[data$Title %in% c('Capt', 'Col', 'Don', 'Dona', 'Dr', 'Jonkheer', 'Lady', 'Major', 'Rev', 'Sir', 'the Countess')] = 'Rare_Title'
  data$Title = factor(data$Title)

  #create FamilySize feature
  familySize = (1 + data$SibSp + data$Parch)

  #discretize FamilySize: 1=Single, 2-4=Small, >5=Large (these values were arrived at by
  #manually examining the data; families of size 2-4 seem to have a better chance of
  #survival than singletons or large families)
  data$FamilySizeDiscrete = cut(familySize, breaks=c(0, 1, 4, 1000), labels=c('Single', 'Small', 'Large'))


  #impute missing values in Age, Fare, Embarked
  print('Imputing missing values...')
  #set them to values precomputed using mice so that I don't have to run mice every time
  data$Age = c(22.00, 38.00, 26.00, 35.00, 35.00, 25.00, 54.00, 2.00, 27.00, 14.00, 4.00, 58.00, 20.00, 39.00, 14.00, 55.00, 2.00, 34.00, 31.00, 19.00, 35.00, 34.00, 15.00, 28.00, 8.00, 38.00, 30.00, 19.00, 36.00, 45.00, 40.00, 48.00, 18.00, 66.00, 28.00, 42.00, 32.50, 21.00, 18.00, 14.00, 40.00, 27.00, 21.00, 3.00, 19.00, 26.00, 32.00, 22.00, 20.00, 18.00,
               7.00, 21.00, 49.00, 29.00, 65.00, 21.00, 21.00, 28.50, 5.00, 11.00, 22.00, 38.00, 45.00, 4.00, 25.00, 0.42, 29.00, 19.00, 17.00, 26.00, 32.00, 16.00, 21.00, 26.00, 32.00, 25.00, 24.00, 35.00, 0.83, 30.00, 22.00, 29.00, 23.00, 28.00, 17.00, 33.00, 16.00, 36.00, 23.00, 24.00, 29.00, 20.00, 46.00, 26.00, 59.00, 27.00, 71.00, 23.00, 34.00, 34.00,
               28.00, 31.00, 21.00, 33.00, 37.00, 28.00, 21.00, 20.00, 38.00, 15.00, 47.00, 14.50, 22.00, 20.00, 17.00, 21.00, 70.50, 29.00, 24.00, 2.00, 21.00, 21.00, 32.50, 32.50, 54.00, 12.00, 33.00, 24.00, 9.00, 45.00, 33.00, 20.00, 47.00, 29.00, 25.00, 23.00, 19.00, 37.00, 16.00, 24.00, 26.00, 22.00, 24.00, 19.00, 18.00, 19.00, 27.00, 9.00, 36.50, 42.00,
               51.00, 22.00, 55.50, 40.50, 23.00, 51.00, 16.00, 30.00, 21.00, 7.00, 44.00, 40.00, 26.00, 17.00, 1.00, 9.00, 23.00, 45.00, 20.00, 28.00, 61.00, 4.00, 1.00, 21.00, 56.00, 18.00, 13.00, 50.00, 30.00, 36.00, 2.00, 34.00, 9.00, 1.00, 4.00, 24.00, 26.00, 45.00, 40.00, 36.00, 32.00, 19.00, 19.00, 3.00, 44.00, 58.00, 23.00, 42.00, 24.00, 24.00, 28.00,
               4.00, 34.00, 45.50, 18.00, 2.00, 32.00, 26.00, 16.00, 40.00, 24.00, 35.00, 22.00, 30.00, 65.00, 31.00, 27.00, 42.00, 32.00, 30.00, 16.00, 27.00, 51.00, 28.00, 38.00, 22.00, 19.00, 20.50, 18.00, 2.00, 35.00, 29.00, 59.00, 5.00, 24.00, 20.00, 44.00, 8.00, 19.00, 33.00, 27.00, 30.00, 29.00, 22.00, 30.00, 44.00, 25.00, 24.00, 37.00, 54.00, 19.00, #250
               29.00, 62.00, 30.00, 41.00, 29.00, 55.00, 30.00, 35.00, 50.00, 43.00, 3.00, 52.00, 40.00, 18.50, 36.00, 16.00, 25.00, 58.00, 35.00, 48.00, 25.00, 41.00, 37.00, 37.00, 63.00, 45.00, 21.00, 7.00, 35.00, 65.00, 28.00, 16.00, 19.00, 27.00, 33.00, 30.00, 22.00, 42.00, 22.00, 26.00, 19.00, 36.00, 24.00, 24.00, 35.00, 23.50, 2.00, 40.00, 50.00, 24.00,
               21.00, 19.00, 30.00, 34.00, 0.92, 30.00, 17.00, 30.00, 30.00, 24.00, 18.00, 26.00, 28.00, 43.00, 26.00, 24.00, 54.00, 31.00, 40.00, 22.00, 27.00, 30.00, 22.00, 14.00, 36.00, 61.00, 36.00, 31.00, 16.00, 18.00, 45.50, 38.00, 16.00, 45.00, 31.00, 29.00, 41.00, 45.00, 45.00, 2.00, 24.00, 28.00, 25.00, 36.00, 24.00, 40.00, 22.00, 3.00, 42.00, 23.00,
               18.00, 15.00, 25.00, 45.00, 28.00, 22.00, 38.00, 30.00, 24.00, 40.00, 29.00, 45.00, 35.00, 36.00, 30.00, 60.00, 40.00, 22.00, 24.00, 25.00, 18.00, 19.00, 22.00, 3.00, 48.00, 22.00, 27.00, 20.00, 19.00, 42.00, 1.00, 32.00, 35.00, 34.00, 18.00, 1.00, 36.00, 40.00, 17.00, 36.00, 21.00, 28.00, 23.00, 24.00, 22.00, 31.00, 46.00, 23.00, 28.00, 39.00,
               26.00, 21.00, 28.00, 20.00, 34.00, 51.00, 3.00, 21.00, 2.00, 42.00, 32.00, 33.00, 18.00, 44.00, 39.00, 34.00, 18.00, 30.00, 10.00, 24.00, 21.00, 29.00, 28.00, 18.00, 18.00, 28.00, 19.00, 33.00, 32.00, 28.00, 30.00, 42.00, 17.00, 50.00, 14.00, 21.00, 24.00, 64.00, 31.00, 45.00, 20.00, 25.00, 28.00, 21.00, 4.00, 13.00, 34.00, 5.00, 52.00, 36.00,
               33.00, 30.00, 49.00, 25.00, 29.00, 65.00, 59.00, 50.00, 34.50, 48.00, 34.00, 47.00, 48.00, 24.50, 38.00, 51.00, 56.00, 70.50, 0.75, 45.00, 38.00, 33.00, 23.00, 22.00, 50.00, 34.00, 29.00, 22.00, 2.00, 9.00, 40.00, 50.00, 63.00, 25.00, 1.00, 35.00, 58.00, 30.00, 9.00, 36.00, 21.00, 55.00, 71.00, 21.00, 33.00, 54.00, 16.00, 25.00, 24.00, 17.00, #500
               21.00, 21.00, 37.00, 16.00, 18.00, 33.00, 17.00, 28.00, 26.00, 29.00, 20.00, 36.00, 54.00, 24.00, 47.00, 34.00, 24.00, 36.00, 32.00, 30.00, 22.00, 26.00, 44.00, 32.00, 40.50, 50.00, 26.00, 39.00, 23.00, 2.00, 28.00, 17.00, 26.00, 30.00, 7.00, 45.00, 30.00, 24.00, 22.00, 36.00, 9.00, 11.00, 32.00, 50.00, 64.00, 19.00, 31.00, 33.00, 8.00, 17.00,
               27.00, 29.00, 22.00, 22.00, 62.00, 48.00, 42.00, 39.00, 36.00, 29.00, 40.00, 28.00, 32.00, 23.00, 24.00, 19.00, 29.00, 32.00, 32.00, 62.00, 53.00, 36.00, 22.00, 16.00, 19.00, 34.00, 39.00, 60.00, 32.00, 25.00, 39.00, 54.00, 36.00, 28.00, 18.00, 47.00, 60.00, 22.00, 40.00, 35.00, 52.00, 47.00, 1.00, 37.00, 36.00, 31.00, 49.00, 25.00, 49.00,
               24.00, 38.00, 28.00, 44.00, 35.00, 36.00, 30.00, 27.00, 22.00, 40.00, 39.00, 22.00, 30.00, 31.00, 35.00, 24.00, 34.00, 26.00, 4.00, 26.00, 27.00, 42.00, 20.00, 21.00, 21.00, 61.00, 57.00, 21.00, 26.00, 40.00, 80.00, 51.00, 32.00, 16.00, 9.00, 28.00, 32.00, 31.00, 41.00, 40.50, 20.00, 24.00, 2.00, 27.00, 0.75, 48.00, 19.00, 56.00, 17.00, 23.00,
               32.00, 18.00, 21.00, 37.00, 18.00, 24.00, 29.00, 32.00, 23.00, 58.00, 50.00, 40.00, 47.00, 36.00, 20.00, 32.00, 25.00, 22.00, 43.00, 35.00, 40.00, 31.00, 70.00, 31.00, 33.00, 18.00, 24.50, 18.00, 43.00, 36.00, 37.00, 27.00, 20.00, 14.00, 60.00, 25.00, 14.00, 19.00, 18.00, 15.00, 31.00, 4.00, 36.00, 25.00, 60.00, 52.00, 44.00, 18.00, 49.00,
               42.00, 18.00, 35.00, 18.00, 25.00, 26.00, 39.00, 45.00, 42.00, 22.00, 0.75, 24.00, 47.00, 48.00, 29.00, 52.00, 19.00, 38.00, 27.00, 58.00, 33.00, 6.00, 17.00, 34.00, 50.00, 27.00, 20.00, 30.00, 22.00, 25.00, 25.00, 29.00, 11.00, 36.00, 23.00, 23.00, 28.50, 48.00, 35.00, 17.00, 21.00, 28.00, 36.00, 21.00, 24.00, 31.00, 70.00, 16.00, 30.00, 19.00,
               31.00, 4.00, 6.00, 33.00, 23.00, 48.00, 0.67, 28.00, 18.00, 34.00, 33.00, 26.00, 41.00, 20.00, 36.00, 16.00, 51.00, 40.00, 30.50, 40.50, 32.00, 24.00, 48.00, 57.00, 47.00, 54.00, 18.00, 34.50, 5.00, 31.00, 43.00, 13.00, 17.00, 29.00, 36.00, 25.00, 25.00, 18.00, 8.00, 1.00, 46.00, 18.00, 16.00, 4.00, 42.00, 25.00, 39.00, 49.00, 31.00, 30.00,
               30.00, 34.00, 31.00, 11.00, 0.42, 27.00, 31.00, 39.00, 18.00, 39.00, 33.00, 26.00, 39.00, 35.00, 6.00, 30.50, 56.00, 23.00, 31.00, 43.00, 10.00, 52.00, 27.00, 38.00, 27.00, 2.00, 26.00, 32.00, 1.00, 31.00, 62.00, 15.00, 0.83, 27.00, 23.00, 18.00, 39.00, 21.00, 20.00, 32.00, 49.00, 20.00, 16.00, 30.00, 34.50, 17.00, 42.00, 19.00, 35.00, 28.00,
               35.00, 4.00, 74.00, 9.00, 16.00, 44.00, 18.00, 45.00, 51.00, 24.00, 44.00, 41.00, 21.00, 48.00, 38.00, 24.00, 42.00, 27.00, 31.00, 28.00, 4.00, 26.00, 47.00, 33.00, 47.00, 28.00, 15.00, 20.00, 19.00, 28.00, 56.00, 25.00, 33.00, 22.00, 28.00, 25.00, 39.00, 27.00, 19.00, 1.00, 26.00, 32.00, 34.50, 47.00, 62.00, 27.00, 22.00, 14.00, 30.00, 26.00,
               18.00, 21.00, 24.00, 46.00, 23.00, 63.00, 47.00, 24.00, 35.00, 21.00, 27.00, 45.00, 55.00, 9.00, 22.00, 21.00, 48.00, 50.00, 22.00, 22.50, 41.00, 65.00, 50.00, 24.00, 33.00, 41.00, 30.00, 18.50, 14.00, 21.00, 25.00, 29.00, 39.00, 47.00, 41.00, 30.00, 45.00, 25.00, 45.00, 36.00, 60.00, 36.00, 24.00, 27.00, 20.00, 28.00, 25.00, 10.00, 35.00,
               25.00, 36.00, 36.00, 17.00, 32.00, 18.00, 22.00, 13.00, 23.00, 18.00, 47.00, 31.00, 60.00, 24.00, 21.00, 29.00, 28.50, 35.00, 32.50, 42.00, 55.00, 30.00, 24.00, 6.00, 67.00, 49.00, 26.00, 18.50, 25.00, 27.00, 18.00, 30.00, 2.00, 22.00, 23.50, 27.00, 38.00, 25.00, 25.00, 76.00, 29.00, 20.00, 33.00, 43.00, 27.00, 29.00, 26.00, 16.00, 28.00, 21.00, #1000
               34.00, 20.00, 18.50, 41.00, 17.00, 36.00, 18.50, 63.00, 18.00, 23.00, 1.00, 36.00, 29.00, 12.00, 48.00, 35.00, 28.00, 61.00, 17.00, 22.00, 16.00, 42.00, 24.00, 32.00, 53.00, 39.00, 22.00, 43.00, 24.00, 26.50, 26.00, 23.00, 40.00, 10.00, 33.00, 61.00, 28.00, 42.00, 31.00, 19.00, 22.00, 32.00, 30.00, 23.00, 27.00, 60.50, 36.00, 13.00, 24.00, 29.00,
               23.00, 42.00, 26.00, 24.00, 7.00, 26.00, 20.00, 41.00, 26.00, 48.00, 18.00, 60.00, 22.00, 32.00, 27.00, 23.00, 45.50, 40.00, 15.00, 20.00, 54.00, 36.00, 64.00, 30.00, 37.00, 18.00, 17.00, 27.00, 40.00, 21.00, 17.00, 5.00, 40.00, 34.00, 55.00, 11.50, 61.00, 8.00, 33.00, 6.00, 18.00, 23.00, 31.00, 18.00, 0.33, 47.00, 8.00, 25.00, 20.00, 35.00, 24.00,
               33.00, 25.00, 32.00, 22.00, 17.00, 60.00, 38.00, 42.00, 21.00, 57.00, 50.00, 30.50, 30.00, 21.00, 22.00, 21.00, 53.00, 26.00, 23.00, 30.00, 40.50, 36.00, 14.00, 21.00, 21.00, 39.00, 39.00, 20.00, 64.00, 20.00, 18.00, 48.00, 55.00, 45.00, 45.00, 55.50, 36.00, 41.00, 22.00, 42.00, 29.00, 30.00, 0.92, 20.00, 27.00, 24.00, 32.50, 25.00, 21.00, 28.00,
               19.00, 21.00, 36.50, 21.00, 29.00, 1.00, 30.00, 24.50, 28.00, 16.00, 22.00, 17.00, 46.00, 38.00, 26.00, 14.00, 20.00, 20.00, 28.00, 40.00, 30.00, 22.00, 23.00, 0.75, 33.00, 9.00, 2.00, 36.00, 25.00, 24.00, 26.00, 25.00, 46.00, 30.00, 11.00, 53.00, 36.00, 26.00, 1.00, 29.00, 30.00, 29.00, 32.00, 39.00, 43.00, 24.00, 45.00, 64.00, 30.00, 0.83, 55.00,
               45.00, 18.00, 22.00, 32.00, 37.00, 55.00, 17.00, 57.00, 19.00, 27.00, 22.00, 26.00, 25.00, 26.00, 33.00, 39.00, 23.00, 12.00, 46.00, 29.00, 21.00, 48.00, 39.00, 36.00, 19.00, 27.00, 30.00, 32.00, 39.00, 25.00, 40.00, 18.00, 32.00, 14.50, 58.00, 17.00, 16.00, 26.00, 38.00, 24.00, 31.00, 45.00, 25.00, 18.00, 49.00, 0.17, 50.00, 59.00, 21.00, 39.00,
               30.00, 14.50, 24.00, 31.00, 27.00, 25.00, 48.00, 31.00, 22.00, 45.00, 29.00, 21.00, 31.00, 49.00, 44.00, 54.00, 45.00, 22.00, 21.00, 55.00, 5.00, 70.50, 26.00, 36.00, 19.00, 34.00, 24.00, 24.00, 57.00, 21.00, 6.00, 23.00, 51.00, 13.00, 47.00, 29.00, 18.00, 24.00, 48.00, 22.00, 31.00, 30.00, 38.00, 22.00, 17.00, 43.00, 20.00, 23.00, 50.00, 37.00,
               3.00, 23.00, 37.00, 28.00, 21.00, 39.00, 38.50, 16.00, 0.75)
  data$Fare[1044] = 8.05
  data$Embarked[c(62, 830)] = 'C'

  #discretize Fare
  data$FareDiscrete = cut(data$Fare, c(-1, 50, 10000), labels=c('Low', 'High'))

  #create Child feature
  data$Child[data$Age < 18] = 'Child'
  data$Child[data$Age >= 18] = 'Adult'
  data$Child = factor(data$Child)

  #create AgeDiscrete feature: 0-6=Young, 7-12=Middle, 13-18=Teen, >18=Adult
  data$AgeDiscrete = cut(data$Age, breaks=c(0, 6, 12, 18, 1000), labels=c('Young', 'Middle', 'Teen', 'Adult'))

  #create Mother feature
  data$Mother = 'NotMother'
  data$Mother[data$Sex == 'female' & data$Age > 18 & data$Parch > 0 & data$Title != 'Miss'] = 'Mother'
  data$Mother = factor(data$Mother)

  return(data)
}

getData = function(simple=FALSE) {
  #read data from file
  train = read.csv('data/train.csv', stringsAsFactors=F, na.strings=c(''))
  test = read.csv('data/test.csv', stringsAsFactors=F, na.strings=c(''))
  full = bind_rows(train, test)

  #manually create factors from some cols
  data$Sex = factor(data$Sex)
  data$Embarked = factor(data$Embarked)
  data$PassengerId = factor(data$PassengerId)
  data$Pclass = factor(data$Pclass)

  #do feature engineering
  full = if(simple) featureEngineerSimple(full) else featureEngineer(full)

  #split the data back into train and test
  train = full[1:nrow(train),]
  test = full[(nrow(train)+1):nrow(full), names(full) != 'Survived']

  return(list(train=train, test=test, full=full))
}

